# ファイルシステムについて

通常のC/C++アプリケーションは、`libc` や `libcxx` 系のライブラリを利用して、同期的なファイルアクセスを行うことができます。一方、JavaScript コード上では、非同期的なファイルアクセスしかできません。加えて、JavaScript では、PC上のローカルファイルに直接アクセスすることができません。

このため、Emscripten では、仮想的なファイルシステムを提供し、ローカルのファイルシステムへのアクセスをエミュレートしています。これにより、ファイルアクセスするようなC/C++アプリケーションをほとんど変更することなく実行することが可能になっています。

## ファイルをパッケージングする
emcc を通して、仮想ファイルシステムに組み込むファイルを指定することができます。これをパッケージングと呼びます。
パッケージングの方法は2種類あります。ページのロード時に事前にXHR経由で読み込む方法(preloading)と、JavaScript コード自体に、データを埋め込んでしまう方法(embedding) です。

JavaScript コードに埋め込む方法は、パフォーマンスが良くないので、少数のファイルや小さいデータのファイルを読み込む際に使用するのがオススメです。

パッケージングする際は、`emcc` を利用します。`emcc`のオプションに `--preload-file dir_name` を指定することで、preloading で組み込むファイルを指定できます。
```
./emcc file.cpp -o file.html --preload-file asset_dir
```
このコマンドを実行すると、`file.html` `file.js` `file.data` が生成されます。`file.data` が、`asset_dir` 内のファイルのデータです。この `file.data` が file.js 経由で読み込まれて、ファイルシステムとしてマウントされます。

`emcc` のオプションに `--embed-file dir_name` を指定することで、embedding で組み込むファイルを指定できます。

```
./emcc file.cpp -o file.html --embed-file asset_dir
```

## MEMFS
Emscripten のデフォルトの仮想ファイルシステムは MEMFS です。これは仮想ファイルシステムをメモリ上に展開します。メモリ上に展開するため、ファイルに書き込んだデータはページをリロードすると失われます。
MEMFS は実行時に、`/` にマウントされます。パッケージしたファイルは、ページへの初回アクセス時に XHR で読み込みされます。
JavaScript に変換されたコードからは、この読み込んだファイルデータに同期／非同期でアクセスすることになります。

# IDBFS
MEMFS は、メモリ上に仮想ファイルシステムを展開するため、ページをリロードすると、ファイルに書き込みしたデータは失われます。
書き込んだデータを永続的に保持したい場合、Web ブラウザ上のページであれば、IDBFS ファイルシステムを利用します。

内部では、`IndexedDB` を利用して、データを永続的にブラウザ側に保持しています。

# NODEFS
NODEFS は、IDBFS と同様にファイルシステムに書き込んだデータを永続的に利用したい場合に使用します。こちらは node.js のためのものです。
NODEFS は、ローカルへのファイルアクセスに直接します。

# ネットワーク上のデータの取得
ネットワーク上からデータを取得する場合、`emscripten_wget()` を利用します。

# ファイルシステムAPI

C/C++ 内で `libc` や `libcxx` 系のライブラリを利用したファイルアクセスは、JavaScript に変換された際に、`FS` ライブラリを呼び出すコードに変換されます。
`FS` ライブラリは、POSIX に非常に似通ったインターフェイスのライブラリです。例えば、`FS.mkdir` はディレクトリを作成する関数ですし、`FS.open` はファイルを開く関数です。


